From 9de7a1b1790741226f9e88c7c026080ca132dc9b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Mikko=20Salom=C3=A4ki?= <ms@datarespons.se>
Date: Thu, 9 May 2019 10:28:03 +0200
Subject: [PATCH] SPI nor flash boot added

---
 board/datarespons/vdt6010/mx6.cfg        |  5 ++---
 board/datarespons/vdt6010/spl.c          | 18 +++++++++++++++-
 board/datarespons/vdt6010/vdt6010.c      |  1 -
 board/datarespons/vdt6010/vdt6010_gpio.h |  2 +-
 board/datarespons/vdt6010/vdt6010_pins.h |  2 +-
 configs/vdt6010_defconfig                | 10 ++++++---
 configs/vdt6010_factory_defconfig        |  5 ++++-
 include/configs/vdt6010.h                | 36 ++++++++++++++++++++++++++++++--
 8 files changed, 66 insertions(+), 13 deletions(-)

diff --git a/board/datarespons/vdt6010/mx6.cfg b/board/datarespons/vdt6010/mx6.cfg
index 9d5347a634..ab271620d5 100644
--- a/board/datarespons/vdt6010/mx6.cfg
+++ b/board/datarespons/vdt6010/mx6.cfg
@@ -17,11 +17,10 @@
 IMAGE_VERSION 2
 
 /*
- * Boot Device : one of
- * spi, sd (the board has no nand neither onenand)
+ * Boot Device : spi/sd/
  */
 
-BOOT_FROM	sd
+BOOT_FROM	spi
 
 #ifdef CONFIG_SECURE_BOOT
 CSF CONFIG_CSF_SIZE
diff --git a/board/datarespons/vdt6010/spl.c b/board/datarespons/vdt6010/spl.c
index c5141c240b..cab95d89aa 100644
--- a/board/datarespons/vdt6010/spl.c
+++ b/board/datarespons/vdt6010/spl.c
@@ -41,6 +41,7 @@ DECLARE_GLOBAL_DATA_PTR;
 
 
 struct fsl_esdhc_cfg usdhc_cfg[1] = {
+	{USDHC2_BASE_ADDR},
 	{USDHC4_BASE_ADDR},
 };
 
@@ -49,12 +50,25 @@ static int get_version(void)
 	return 0;
 }
 
+int board_spi_cs_gpio(unsigned bus, unsigned cs)
+{
+	if (bus == 1 && cs == 0) {
+		return SPI_NOR_CS;
+	}
+
+	return -1;
+}
+
 int board_mmc_getcd(struct mmc *mmc)
 {
 	struct fsl_esdhc_cfg *cfg = (struct fsl_esdhc_cfg *)mmc->priv;
 	int ret = 0;
 
 	switch (cfg->esdhc_base) {
+	case USDHC2_BASE_ADDR:
+		ret = !gpio_get_value(USDHC2_CD);
+		break;
+
 	case USDHC4_BASE_ADDR:
 		ret = 1;
 		break;
@@ -79,6 +93,7 @@ int board_mmc_init(bd_t *bis)
 	switch (reg & 0x3) {
 	case 0x1:
 		SETUP_IOMUX_PADS(usdhc2_pads);
+		gpio_direction_input(USDHC2_CD);
 		usdhc_cfg[0].esdhc_base = USDHC2_BASE_ADDR;
 		usdhc_cfg[0].sdhc_clk = mxc_get_clock(MXC_ESDHC2_CLK);
 		gd->arch.sdhc_clk = usdhc_cfg[0].sdhc_clk;
@@ -206,7 +221,7 @@ static void ccgr_init(void)
 	struct mxc_ccm_reg *ccm = (struct mxc_ccm_reg *)CCM_BASE_ADDR;
 
 	writel(0x00C03F3F, &ccm->CCGR0);
-	writel(0x0030FF03, &ccm->CCGR1);
+	writel(0x0030FF0F, &ccm->CCGR1);
 	writel(0x0FFFC000, &ccm->CCGR2);
 	writel(0x3FF00000, &ccm->CCGR3);
 	writel(0x00FFF300, &ccm->CCGR4);
@@ -222,6 +237,7 @@ static void spl_dram_init(void)
 
 int board_early_init_f(void)
 {
+	SETUP_IOMUX_PADS(spi_nor_pads);
 	SETUP_IOMUX_PADS(uart5_pads);
 
 	return 0;
diff --git a/board/datarespons/vdt6010/vdt6010.c b/board/datarespons/vdt6010/vdt6010.c
index d3c88fe478..889f182308 100644
--- a/board/datarespons/vdt6010/vdt6010.c
+++ b/board/datarespons/vdt6010/vdt6010.c
@@ -54,7 +54,6 @@ DECLARE_GLOBAL_DATA_PTR;
 int board_early_init_f(void)
 {
 	SETUP_IOMUX_PADS(uart1_pads);
-	SETUP_IOMUX_PADS(spi_nor_pads);
 	SETUP_IOMUX_PADS(pwm_pads);
 	SETUP_IOMUX_PADS(gpio_pads);
 	SETUP_IOMUX_PADS(other_pads);
diff --git a/board/datarespons/vdt6010/vdt6010_gpio.h b/board/datarespons/vdt6010/vdt6010_gpio.h
index a180e0f5cc..6a23c9150a 100644
--- a/board/datarespons/vdt6010/vdt6010_gpio.h
+++ b/board/datarespons/vdt6010/vdt6010_gpio.h
@@ -4,7 +4,7 @@
 #include <asm/gpio.h>
 
 #define USDHC2_CD		IMX_GPIO_NR(1, 4)
-#define SPI_NOR_CS		IMX_GPIO_NR(5, 5)
+#define SPI_NOR_CS		IMX_GPIO_NR(5, 29)
 
 #define UART1_RS485EN2	IMX_GPIO_NR(4, 11)
 #define UART1_RS422EN2	IMX_GPIO_NR(4, 10)
diff --git a/board/datarespons/vdt6010/vdt6010_pins.h b/board/datarespons/vdt6010/vdt6010_pins.h
index 25651b2858..b2e2dc58d5 100644
--- a/board/datarespons/vdt6010/vdt6010_pins.h
+++ b/board/datarespons/vdt6010/vdt6010_pins.h
@@ -95,7 +95,7 @@ static iomux_v3_cfg_t const spi_nor_pads[] = {
 	IOMUX_PADS(PAD_CSI0_DAT8__ECSPI2_SCLK | MUX_PAD_CTRL(SPI_PAD_CTRL)),
 	IOMUX_PADS(PAD_CSI0_DAT9__ECSPI2_MOSI | MUX_PAD_CTRL(SPI_PAD_CTRL)),
 	IOMUX_PADS(PAD_CSI0_DAT10__ECSPI2_MISO | MUX_PAD_CTRL(SPI_PAD_CTRL)),
-	IOMUX_PADS(PAD_DISP0_DAT11__GPIO5_IO05 | MUX_PAD_CTRL(NO_PAD_CTRL)), // cs
+	IOMUX_PADS(PAD_CSI0_DAT11__GPIO5_IO29 | MUX_PAD_CTRL(SPI_PAD_CTRL)), // cs
 };
 
 static iomux_v3_cfg_t const pwm_pads[] = {
diff --git a/configs/vdt6010_defconfig b/configs/vdt6010_defconfig
index 50f7a793bc..37e368c8f2 100644
--- a/configs/vdt6010_defconfig
+++ b/configs/vdt6010_defconfig
@@ -52,8 +52,12 @@ CONFIG_SPL_SERIAL_SUPPORT=y
 CONFIG_SPL_LIBDISK_SUPPORT=y
 CONFIG_SPL_WATCHDOG_SUPPORT=y
 CONFIG_SPL_OS_BOOT=n
-CONFIG_SPL_USB_GADGET_SUPPORT=y
-CONFIG_SPL_USB_SDP_SUPPORT=y
-CONFIG_SPL_USB_HOST_SUPPORT=y
+CONFIG_SPL_USB_GADGET_SUPPORT=n
+CONFIG_SPL_USB_SDP_SUPPORT=n
+CONFIG_SPL_USB_HOST_SUPPORT=n
 CONFIG_USB_GADGET_VENDOR_NUM=0x0525
 CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
+CONFIG_SPL_SPI_FLASH_SUPPORT=y
+CONFIG_SPL_SPI_SUPPORT=y
+CONFIG_SPL_SPI_LOAD=y
+CONFIG_FACTORY_BOOT=n
diff --git a/configs/vdt6010_factory_defconfig b/configs/vdt6010_factory_defconfig
index 059f023753..5c12860960 100644
--- a/configs/vdt6010_factory_defconfig
+++ b/configs/vdt6010_factory_defconfig
@@ -57,4 +57,7 @@ CONFIG_SPL_USB_SDP_SUPPORT=y
 CONFIG_SPL_USB_HOST_SUPPORT=y
 CONFIG_USB_GADGET_VENDOR_NUM=0x0525
 CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
-CONFIG_FACTORY_BOOT=y
\ No newline at end of file
+CONFIG_SPL_SPI_FLASH_SUPPORT=n
+CONFIG_SPL_SPI_SUPPORT=n
+CONFIG_SPL_SPI_LOAD=n
+CONFIG_FACTORY_BOOT=y
diff --git a/include/configs/vdt6010.h b/include/configs/vdt6010.h
index e318eee3ea..ce500c75ae 100644
--- a/include/configs/vdt6010.h
+++ b/include/configs/vdt6010.h
@@ -10,7 +10,7 @@
 #define __VDT6010_CONFIG_H
 
 /*
-#ifndef CONFIG_SPL_BUILD
+#ifdef CONFIG_SPL_BUILD
 #define DEBUG
 #endif
 */
@@ -24,6 +24,34 @@
 #define CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR 512
 #endif
 
+
+
+/* u-boot offset in SPI FLASH */
+#define CONFIG_SYS_SPI_U_BOOT_OFFS (256 * 1024)
+#define CONFIG_CMD_SF
+#define CONFIG_SPI_FLASH
+#define CONFIG_SPI_FLASH_WINBOND
+#define CONFIG_MXC_SPI
+#define CONFIG_SF_DEFAULT_BUS		1
+#define CONFIG_SF_DEFAULT_CS		0
+#define CONFIG_SF_DEFAULT_SPEED		20000000
+#define CONFIG_SF_DEFAULT_MODE		SPI_MODE_0
+
+/* Flash and environment organization */
+/*#define CONFIG_SYS_NO_FLASH*/
+/*
+#define CONFIG_ENV_OVERWRITE
+#define CONFIG_ENV_IS_IN_SPI_FLASH
+
+#define CONFIG_ENV_SIZE			(64 * 1024)
+#define CONFIG_ENV_SECT_SIZE 	(64 * 1024)
+#define CONFIG_ENV_SPI_BUS             CONFIG_SF_DEFAULT_BUS
+#define CONFIG_ENV_SPI_CS              CONFIG_SF_DEFAULT_CS
+#define CONFIG_ENV_SPI_MODE            CONFIG_SF_DEFAULT_MODE
+#define CONFIG_ENV_SPI_MAX_HZ          CONFIG_SF_DEFAULT_SPEED
+#define CONFIG_ENV_OFFSET		(0xc0000)
+*/
+
 #define CONFIG_MXC_UART_BASE	UART5_BASE
 #define CONSOLE_DEV		"ttymxc4"
 #define CONFIG_IMX_WATCHDOG
@@ -241,7 +269,11 @@
 #define CONFIG_SYS_LOAD_ADDR           CONFIG_LOADADDR
 
 /* Physical Memory Map */
-#define CONFIG_NR_DRAM_BANKS           1
+
+/*
+ * u-boot 2018.11 complains this is already defined.
+ * Should this be undefined in our board?"
+ * #define CONFIG_NR_DRAM_BANKS           1*/
 #define PHYS_SDRAM                     MMDC0_ARB_BASE_ADDR
 #define PHYS_SDRAM_SIZE		(2u * 1024 * 1024 * 1024)
 
