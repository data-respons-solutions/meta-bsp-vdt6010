From 88dc58193bb10e0dd7671a5b19c5ac90b0644bd6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Mikko=20Salom=C3=A4ki?= <ms@datarespons.se>
Date: Wed, 15 May 2019 08:12:44 +0200
Subject: [PATCH] Add display

---
 board/datarespons/vdt6010/spl.c          |   2 +-
 board/datarespons/vdt6010/vdt6010.c      | 147 ++++++++++++++++++++++++++++++-
 board/datarespons/vdt6010/vdt6010_gpio.h |   5 +-
 board/datarespons/vdt6010/vdt6010_pins.h |   4 +-
 configs/vdt6010_defconfig                |   1 +
 configs/vdt6010_factory_defconfig        |   1 +
 include/configs/vdt6010.h                |  11 +++
 7 files changed, 164 insertions(+), 7 deletions(-)

diff --git a/board/datarespons/vdt6010/spl.c b/board/datarespons/vdt6010/spl.c
index cab95d89aa..b725ef6861 100644
--- a/board/datarespons/vdt6010/spl.c
+++ b/board/datarespons/vdt6010/spl.c
@@ -226,7 +226,7 @@ static void ccgr_init(void)
 	writel(0x3FF00000, &ccm->CCGR3);
 	writel(0x00FFF300, &ccm->CCGR4);
 	writel(0x0F0000C3, &ccm->CCGR5);
-	writel(0x000003FF, &ccm->CCGR6);
+	writel(0x00000339, &ccm->CCGR6);
 }
 
 static void spl_dram_init(void)
diff --git a/board/datarespons/vdt6010/vdt6010.c b/board/datarespons/vdt6010/vdt6010.c
index 889f182308..fabd045776 100644
--- a/board/datarespons/vdt6010/vdt6010.c
+++ b/board/datarespons/vdt6010/vdt6010.c
@@ -51,17 +51,162 @@ DECLARE_GLOBAL_DATA_PTR;
  *
  */
 
+static void disable_lvds(struct display_info_t const *dev)
+{
+	struct iomuxc *iomux = (struct iomuxc *)IOMUXC_BASE_ADDR;
+
+	int reg = readl(&iomux->gpr[2]);
+
+	reg &= ~(IOMUXC_GPR2_LVDS_CH0_MODE_MASK |
+		 IOMUXC_GPR2_LVDS_CH1_MODE_MASK);
+
+	writel(reg, &iomux->gpr[2]);
+}
+
+static void do_enable_hdmi(struct display_info_t const *dev)
+{
+	disable_lvds(dev);
+	imx_enable_hdmi_phy();
+}
+
+static void enable_lvds(struct display_info_t const *dev)
+{
+	struct iomuxc *iomux = (struct iomuxc *)
+				IOMUXC_BASE_ADDR;
+	u32 reg = readl(&iomux->gpr[2]);
+	reg |= IOMUXC_GPR2_DATA_WIDTH_CH0_24BIT |
+	       IOMUXC_GPR2_DATA_WIDTH_CH1_24BIT;
+	writel(reg, &iomux->gpr[2]);
+}
+
+
+struct display_info_t const displays[] = {{
+	.bus	= -1,
+	.addr	= 0,
+	.pixfmt	= IPU_PIX_FMT_RGB24,
+	.detect	= NULL,
+	.enable	= enable_lvds,
+	.mode	= {
+			.name           = "MXXF1-XGA",
+			.refresh        = 60,
+			.xres           = 1280,
+			.yres           = 800,
+			.pixclock       = 1000000 / 71100000,
+			.left_margin    = 50,
+			.right_margin   = 50,
+			.upper_margin   = 10,
+			.lower_margin   = 10,
+			.hsync_len      = 60,
+			.vsync_len      = 3,
+			.sync           = FB_SYNC_EXT,
+			.vmode          = FB_VMODE_NONINTERLACED
+} }, {
+	.bus	= -1,
+	.addr	= 0,
+	.pixfmt	= IPU_PIX_FMT_RGB24,
+	.detect	= detect_hdmi,
+	.enable	= do_enable_hdmi,
+	.mode	= {
+			.name           = "HDMI",
+			.refresh        = 60,
+			.xres           = 1280,
+			.yres           = 720,
+			.pixclock       = 15686,
+			.left_margin    = 48,
+			.right_margin   = 32,
+			.upper_margin   = 3,
+			.lower_margin   = 5,
+			.hsync_len      = 80,
+			.vsync_len      = 13,
+			.sync           = FB_SYNC_EXT,
+			.vmode          = FB_VMODE_NONINTERLACED
+} },  };
+size_t display_count = ARRAY_SIZE(displays);
+
+static void setup_display_clock(void)
+{
+	struct mxc_ccm_reg *mxc_ccm = (struct mxc_ccm_reg *)CCM_BASE_ADDR;
+	struct iomuxc *iomux = (struct iomuxc *)IOMUXC_BASE_ADDR;
+	int reg;
+
+	enable_ipu_clock();
+	imx_setup_hdmi();
+
+	/* Turn on LDB0, LDB1, IPU,IPU DI0 clocks */
+	reg = readl(&mxc_ccm->CCGR3);
+	reg |=  MXC_CCM_CCGR3_LDB_DI0_MASK | MXC_CCM_CCGR3_LDB_DI1_MASK;
+	writel(reg, &mxc_ccm->CCGR3);
+
+	/* set LDB0, LDB1 clk select to 011/011 */
+	reg = readl(&mxc_ccm->cs2cdr);
+	reg &= ~(MXC_CCM_CS2CDR_LDB_DI0_CLK_SEL_MASK
+		 | MXC_CCM_CS2CDR_LDB_DI1_CLK_SEL_MASK);
+	reg |= (3 << MXC_CCM_CS2CDR_LDB_DI0_CLK_SEL_OFFSET)
+	      | (3 << MXC_CCM_CS2CDR_LDB_DI1_CLK_SEL_OFFSET);
+	writel(reg, &mxc_ccm->cs2cdr);
+
+	reg = readl(&mxc_ccm->cscmr2);
+	reg |= MXC_CCM_CSCMR2_LDB_DI0_IPU_DIV | MXC_CCM_CSCMR2_LDB_DI1_IPU_DIV;
+	writel(reg, &mxc_ccm->cscmr2);
+
+	reg = readl(&mxc_ccm->chsccdr);
+	reg |= (CHSCCDR_CLK_SEL_LDB_DI0
+		<< MXC_CCM_CHSCCDR_IPU1_DI0_CLK_SEL_OFFSET);
+	reg |= (CHSCCDR_CLK_SEL_LDB_DI0
+		<< MXC_CCM_CHSCCDR_IPU1_DI1_CLK_SEL_OFFSET);
+	writel(reg, &mxc_ccm->chsccdr);
+
+	reg = IOMUXC_GPR2_BGREF_RRMODE_EXTERNAL_RES
+	     | IOMUXC_GPR2_DI1_VS_POLARITY_ACTIVE_LOW
+	     | IOMUXC_GPR2_DI0_VS_POLARITY_ACTIVE_LOW
+	     | IOMUXC_GPR2_BIT_MAPPING_CH1_SPWG
+	     | IOMUXC_GPR2_DATA_WIDTH_CH1_24BIT
+	     | IOMUXC_GPR2_BIT_MAPPING_CH0_SPWG
+	     | IOMUXC_GPR2_DATA_WIDTH_CH0_24BIT
+	     | IOMUXC_GPR2_LVDS_CH1_MODE_DISABLED
+	     | IOMUXC_GPR2_LVDS_CH0_MODE_ENABLED_DI0;
+	writel(reg, &iomux->gpr[2]);
+
+	reg = readl(&iomux->gpr[3]);
+	reg = (reg & ~(IOMUXC_GPR3_LVDS0_MUX_CTL_MASK
+			| IOMUXC_GPR3_HDMI_MUX_CTL_MASK))
+	    | (IOMUXC_GPR3_MUX_SRC_IPU1_DI0
+	       << IOMUXC_GPR3_LVDS0_MUX_CTL_OFFSET);
+	writel(reg, &iomux->gpr[3]);
+}
+
+static void setup_backlight(void)
+{
+	SETUP_IOMUX_PADS(pwm_pads);
+
+	gpio_set_value(LED_VCC_EN, 1);
+	gpio_set_value(LED_EN, 1);
+
+	if (pwm_config(0, 100000, 100000)) {
+		printf("%s: pwm_config failed\n");
+	}
+
+	pwm_enable(0);
+}
+
 int board_early_init_f(void)
 {
 	SETUP_IOMUX_PADS(uart1_pads);
-	SETUP_IOMUX_PADS(pwm_pads);
 	SETUP_IOMUX_PADS(gpio_pads);
 	SETUP_IOMUX_PADS(other_pads);
 
+	gpio_direction_output(LED_VCC_EN, 0);
+	gpio_direction_output(LED_EN, 0);
+	gpio_direction_output(LCD_VDD_EN, 0);
+
 	setup_i2c(0, CONFIG_SYS_I2C_SPEED, 0x7f, &mx6dq_i2c_pad_info0);
 	setup_i2c(1, CONFIG_SYS_I2C_SPEED, 0x7f, &mx6dq_i2c_pad_info1);
 	setup_i2c(2, CONFIG_SYS_I2C_SPEED, 0x7f, &mx6dq_i2c_pad_info2);
 
+	setup_display_clock();
+	gpio_set_value(LCD_VDD_EN, 0);
+	setup_backlight();
+
 	return 0;
 }
 
diff --git a/board/datarespons/vdt6010/vdt6010_gpio.h b/board/datarespons/vdt6010/vdt6010_gpio.h
index 6a23c9150a..ba8b2a6b08 100644
--- a/board/datarespons/vdt6010/vdt6010_gpio.h
+++ b/board/datarespons/vdt6010/vdt6010_gpio.h
@@ -28,13 +28,12 @@
 #define PCIE_RST		IMX_GPIO_NR(4, 8)
 
 #define GPIO_MCU		IMX_GPIO_NR(1, 0)
+
 #define LED_VCC_EN		IMX_GPIO_NR(1, 5)
+#define LED_EN			IMX_GPIO_NR(7, 12)
 #define LCD_VDD_EN		IMX_GPIO_NR(1, 6)
-#define CABC_EN			IMX_GPIO_NR(1, 7)
-#define BIST			IMX_GPIO_NR(1, 8)
 #define DEBUG_LED		IMX_GPIO_NR(7, 8)
 #define RTC_IRQ			IMX_GPIO_NR(1, 3)
 #define PMIC_INT		IMX_GPIO_NR(7, 13)
-#define LED_EN			IMX_GPIO_NR(7, 12)
 
 #endif /* __VDT6010_GPIO_H__ */
diff --git a/board/datarespons/vdt6010/vdt6010_pins.h b/board/datarespons/vdt6010/vdt6010_pins.h
index b2e2dc58d5..cc7fb4f81a 100644
--- a/board/datarespons/vdt6010/vdt6010_pins.h
+++ b/board/datarespons/vdt6010/vdt6010_pins.h
@@ -50,7 +50,7 @@ static iomux_v3_cfg_t const enet_pads[] = {
 	IOMUX_PADS(PAD_ENET_TXD0__ENET_TX_DATA0	| MUX_PAD_CTRL(ENET_PAD_CTRL)),
 	IOMUX_PADS(PAD_ENET_TXD1__ENET_TX_DATA1	| MUX_PAD_CTRL(ENET_PAD_CTRL)),
 	IOMUX_PADS(PAD_NANDF_CS1__GPIO6_IO14 | MUX_PAD_CTRL(NO_PAD_CTRL)),	// LAN8710 nRST
-	IOMUX_PADS(PAD_GPIO_9__GPIO1_IO09 | MUX_PAD_CTRL(NO_PAD_CTRL)),		// LAN8710 IRQ#
+	IOMUX_PADS(PAD_GPIO_9__GPIO1_IO09 | MUX_PAD_CTRL(WEAK_PULLUP)),		// LAN8710 IRQ#
 	IOMUX_PADS(PAD_GPIO_16__ENET_REF_CLK | MUX_PAD_CTRL(ENET_PAD_CTRL)),
 };
 
@@ -99,7 +99,7 @@ static iomux_v3_cfg_t const spi_nor_pads[] = {
 };
 
 static iomux_v3_cfg_t const pwm_pads[] = {
-	IOMUX_PADS(PAD_SD1_DAT3__PWM1_OUT | MUX_PAD_CTRL(NO_PAD_CTRL)),
+	IOMUX_PADS(PAD_SD1_DAT3__PWM1_OUT | MUX_PAD_CTRL(OUT_LOW_PAD_CTRL)),
 };
 
 static iomux_v3_cfg_t const other_pads[] = {
diff --git a/configs/vdt6010_defconfig b/configs/vdt6010_defconfig
index 37e368c8f2..b9eea759cb 100644
--- a/configs/vdt6010_defconfig
+++ b/configs/vdt6010_defconfig
@@ -61,3 +61,4 @@ CONFIG_SPL_SPI_FLASH_SUPPORT=y
 CONFIG_SPL_SPI_SUPPORT=y
 CONFIG_SPL_SPI_LOAD=y
 CONFIG_FACTORY_BOOT=n
+CONFIG_VIDEO=y
diff --git a/configs/vdt6010_factory_defconfig b/configs/vdt6010_factory_defconfig
index 5c12860960..ea83bba8c4 100644
--- a/configs/vdt6010_factory_defconfig
+++ b/configs/vdt6010_factory_defconfig
@@ -61,3 +61,4 @@ CONFIG_SPL_SPI_FLASH_SUPPORT=n
 CONFIG_SPL_SPI_SUPPORT=n
 CONFIG_SPL_SPI_LOAD=n
 CONFIG_FACTORY_BOOT=y
+CONFIG_VIDEO=y
diff --git a/include/configs/vdt6010.h b/include/configs/vdt6010.h
index ce500c75ae..b0ed7ccb72 100644
--- a/include/configs/vdt6010.h
+++ b/include/configs/vdt6010.h
@@ -317,6 +317,17 @@
 #define CONFIG_SYS_I2C_MXC
 #define CONFIG_SYS_I2C_SPEED		  100000
 
+/* IPU */
+#define CONFIG_VIDEO_IPUV3
+#define CONFIG_VIDEO_BMP_RLE8
+#define CONFIG_SPLASH_SCREEN
+#define CONFIG_SPLASH_SCREEN_ALIGN
+#define CONFIG_BMP_16BPP
+#define CONFIG_VIDEO_LOGO
+#define CONFIG_VIDEO_BMP_LOGO
+#define CONFIG_IMX_HDMI
+/*#define CONFIG_IMX_VIDEO_SKIP*/
+
 /* PMIC */
 /*
 #define CONFIG_POWER
